# 实验报告
实现类选题二：机器学习模型交易完整流程

参考论文：[A Marketplace for Data: An Algorithmic Solution](https://arxiv.org/pdf/1805.08125)

## 一、问题描述
在当今机器学习广泛应用于商业决策的背景下，数据成为了一种极具价值的商品。高质量的训练数据直接决定了模型的预测性能，然而，大多数企业，尤其是处于早期阶段的企业，难以自行获取足够且相关的数据集。此外，预测任务高度多样化，数据价值具有强烈的组合性（即多个数据集的联合价值非简单可加），并且在未实际应用之前，无法预先评估数据的有效性。更为复杂的是，数据本身是一种可无限复制的数字商品，这种特性使得传统的市场机制（如在线广告拍卖、预测市场）无法直接适用。

本文正是针对这一背景，提出了一个核心问题：如何设计一个在理论上合理且在计算上可行的数据交易市场，使得数据买卖双方能够通过市场机制实现真实报价、动态定价与收益合理分配？

我们将论文尝试解决的问题概括为以下：

1. 如何为数据定价，尤其是具有组合价值的数据集合？
2. 如何激励买家如实揭示其对预测精度的真实估值？
3. 如何将由预测增益所产生的收益合理地分配给数据卖家？
4. 如何设计上述机制的算法，使其在大规模在线市场中实时可运行？

因此，我们把实现目标分为三个步骤：第一步是诚实的机器学习模型拍卖，第二步是 MWU 算法动态定价，第三步是收益分配。 最终将三个步骤连接，完成完整流程的所有功能。


## 二、文章整体思路


文章提出了一个完整的数据市场架构，并将其建模为一个**双边市场（two-sided market）**:

* **卖家**: 每个卖家提供一个数据特征（如时间序列），其本质为可复制的数字商品；
* **买家**: 每个买家带有一个特定的预测任务（如时间序列预测）以及对预测精度提高的**主观估值（μ）**。

以下是论文涉及的关键术语：

| 符号/变量       | 程序中体现                                | 实际含义              |
| ----------- | ------------------------------------ | ----------------- |
| $\mu$       | `mu = buyer["mu"]`                   | 买家愿意为 1 单位提升支付的价格 |
| $b$         | `b = mu`                             | 买家出价（我们简化设为 μ）    |
| $p_n$       | `p_n = price_updater.choose_price()` | 当前市场定价            |
| $X$         | `X = buyer["X"]`                     | 所有卖家提供的特征矩阵       |
| $\tilde{X}$ | `X_tilde = allocation_function(...)` | 根据 p 和 b 分配的数据    |
| $Y$         | `Y = buyer["Y"]`                     | 预测目标              |
| $\hat{Y}$   | `Y_hat = train_and_predict(...)`     | 预测值               |
| $G$         | `gain = gain_function(...)`          | 模型的预测效果提升         |
| RF          | `revenue = revenue_function(...)`    | 实际支付金额            |
| Shapley     | `allocate_revenue(...)`              | 卖家的边际贡献分配收益       |




文章从理论上提出并分析了一个**满足以下四个核心性质**的机制：

* **真诚性（Truthfulness）**：买家会被激励说出其真实的估值；
* **收益最大化（Revenue Maximization）**：定价机制在长期下具有零后悔性能；
* **公平分配（Shapley Fairness + Robustness to Replication）**：卖家根据特征对精度提升的真实贡献获得报酬，且机制不被复制数据操纵；
* **计算高效（Computational Efficiency）**：所有机制均可在合理时间复杂度下在线运行。

为实现上述目标，设计了如下的关键模块（将要在程序中全部实现）

1. **基于Myerson机制的支付规则**，用于确保买家报价真实；
2. **乘性权重更新法（MWU）**，用于实现价格的动态调整，保证长期最优；
3. **Shapley值近似算法与鲁棒修正机制**，用于公平且抗复制地分配收益；
4. **基于加噪或子采样的特征分配策略**，使市场能调控数据“质量”，实现差异化售卖。

基于以上，整个市场流程设计为一个实时在线机制，每当一个新买家到达时，市场根据当前的价格策略进行以下步骤（`main.py`中串联）

```
买家进场（带着估值μ、预测任务Y）
        ↓

市场使用 MWU 算法 → 给出当前价格p_n
        ↓

买家出价 b = μ

        ↓

市场分配数据（加噪、截断等）X_tilde
模型训练 → 得到预测结果 Y_hat

        ↓

 计算准确率提升 G
 根据 RF 收费（Myerson）
        ↓

更新价格策略（MWU 权重调整）
        ↓

用 Shapley 分配给每个特征的收益

        ↓
市场统计分析（价格演化、卖家收益）
```

为方便理解，接下来我们将用一个实例清晰的展示论文中阐释的完整流程
### 实例

#### 卖家（2人）：提供数据特征
卖家 A 提供特征 `X[:,0]`，表示“天气温度”

卖家 B 提供特征 `X[:,1]`，表示“人流量”

#### 买家（3人）：有预测任务与估值

| 买家编号    | 任务内容     | 真实估值 $\mu$ | 特征 $X$（2列）                                         | 标签 $Y$       |
| ------- | -------- | ---------- | -------------------------------------------------- | ------------ |
| Buyer 1 | 预测冰淇淋销量  | 80.0       | $\begin{bmatrix}30 & 50 \\ 32 & 55\end{bmatrix}$   | $[100, 110]$ |
| Buyer 2 | 预测超市客流峰值 | 60.0       | $\begin{bmatrix}25 & 100 \\ 26 & 110\end{bmatrix}$ | $[200, 220]$ |
| Buyer 3 | 预测咖啡销量   | 40.0       | $\begin{bmatrix}15 & 20 \\ 18 & 25\end{bmatrix}$   | $[80, 85]$   |

我们把 $X$ 理解为特征矩阵，2 列对应 2 个卖家的数据。

---

#### 模拟流程：
**(1) Buyer 1 到达（预测冰淇淋销量）**


* 估值：$\mu = 80$ → 每多提升 1 的准确率，愿意支付 80
* 报价：$b = \mu = 80$
* 市场当前定价：假设 $p_1 = 60$（由 MWU 定出来）

发生：
* $b > p$，买家获得了完整的 X（无加噪）。使用 X 训练模型 → 得到预测 Y\_hat
* 设 gain = 0.85（预测准确率提升 85%），revenue 由 RF\* 计算，约为：

  $$
  \text{RF}^* = b \cdot G - \int_0^b G(z)\,dz ≈ 80 \cdot 0.85 - \text{area under gain curve}
  \Rightarrow \text{revenue} = 65
  $$

* 分配收益（Shapley）：
计算特征 0 和 1 的边际贡献，
设特征 0 对提升贡献 70%，特征 1 贡献 30%。
卖家 A 得到 \$45.5，B 得到 \$19.5

```python
shapley_weights = {0: 0.7, 1: 0.3}
revenue = 65
seller_revenue[0] += 45.5
seller_revenue[1] += 19.5
```
---

**(2) Buyer 2 到达（预测超市客流）**

* mu = 60, b = 60 当前价格 p\_2 = 70（MWU 提高了价格）

* 因为 b < p，X 被部分掩盖，例如将特征变为：

  $$
  \tilde{X} = \begin{bmatrix}0 & 100 \\ 0 & 110\end{bmatrix}
  $$

  → 特征 0（天气）被屏蔽，买家只能用人流量特征预测

* 预测提升下降为 gain = 0.45，收费 RF ≈ 38  ，Shapley 分配： 只有特征 1 有效 → 卖家 B 拿走全部 38

---

**(3) Buyer 3 到达（预测咖啡限量）**

* mu = 40，b = 40，当前 p\_3 = 30（MWU 降低价格）
* X 完整分配，模型预测结果提升 gain = 0.7 revenue = 28
* Shapley 权重 {0: 0.6, 1: 0.4}：卖家 A 得到 16.8，B 得到 11.2

---

最终结果

```text
市场价格动态:
买家 1: p = 60.00
买家 2: p = 70.00
买家 3: p = 30.00

卖家总收益分配（基于边际贡献）:
特征 0: 收益 = 62.3
特征 1: 收益 = 68.7
```


















## 三、关键定理的描述

## 四、实现的核心算法介绍

为实现第一部分提到的完整市场机器学习模型交易流程，
我们设计项目结构如下：
```
data-marketplace/
│
├── data/                    # 存放模拟数据（买家传入信息）
│   └── buyer_data.json
│
├── models/                  # 机器学习模型 预测部分
│   └── learner.py
│
├── market/                  # 拍卖、定价、收益分配逻辑
│   ├── auction.py           # 诚实机制（AF + RF）
│   ├── pricing.py           # MWU 动态定价
│   └── revenue.py           # Shapley 收益分配
│
├── utils/                   # 公共函数
│   └── metrics.py           # 指标数学计算
│   └── io.py                # 加载测试数据
│
└── main.py                  # 主程序入口：输入一个买家 → 运行三步流程
```


接下来我们将分为三个核心功能模块，分别介绍关键算法：
### (1) 诚实的机器学习模型拍卖(`auction.py`)
该模块需要实现的功能如下
1. 接收买家提交的预测任务 $Y_n$ 和出价 $b_n$
2. 分配特征数据 $\widetilde{X}_M = AF(p_n, b_n; X_M)$，即根据信噪比决定特征质量（添加噪声或mask）
3. 用模型 $M$ 进行预测 $\hat{Y}_n = M(\widetilde{X}_M)$,计算预测增益 $G(Y_n, \hat{Y}_n)$
4. 利用 Myerson Payment Function 计算支付金额 $RF^*$

#### 算法 1：基于 Myerson Payment Rule 构建的 RF
#### 算法 2：noise 处理及优化
### (2) MWU 算法动态定价(`pricing.py`)
该模块需要实现的功能如下
1. 维护一个价格候选集合（通过离散化 bidder bid 范围构造 epsilon-net）
2. 初始化每个价格候选的权重为 1
3. 每轮 buyer 到达时：
   * 根据当前权重采样一个价格 $p_n$
   * 用该价格进行拍卖（运行第一步流程），得到收入 $r_n$
   * 根据该轮的 revenue 更新权重，设 $g_i^n = \frac{\text{RF}(c_i, b_n, Y_n)}{B_{\max}}$：第 $i$ 个价格在当前买家的表现，更新第 $i$ 个价格的权重：

     $$
     w_i^{n+1} = w_i^n \cdot (1 + \delta \cdot g_i^n)
     $$
4. 收敛时达到 regret 最小化




### (3) 收益分配(`revenue.py`)
该模块需要实现的功能如下

利用 Shapley sampling 估计每个特征的边际贡献：

   * 随机排列 seller 顺序
   * 对每种排列，计算某特征的“加入前后”预测增益
   * 多次采样后求平均，得到近似 Shapley 值

## 五、实验结果与分析